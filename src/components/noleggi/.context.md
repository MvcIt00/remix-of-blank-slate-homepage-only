# CONTEXT: NOLEGGI, ALLARMI & TRASPORTI

## üéØ Filosofia del Modulo (Axioms Compliance)

Questo modulo gestisce il ciclo di vita operativo dei noleggi, trasformando dati statici in **allarmi azionabili**. segue rigorosamente gli assiomi definiti in `user_global`:

- **AX03 (Stati Progressivi)**: Utilizza stati `futuro`, `attivo`, `scaduto`, `terminato` per riflettere le fasi operative reali.
- **AX04 (Informazione Stratificata)**: La dashboard mostra tutto a colpo d'occhio senza filtri pesanti nascosti.
- **AX06 (Contesto Prima)**: Le azioni (es. Richiedi Trasporto) partono da un noleggio esistente, pre-compilando i dati per ridurre errori (AX06).

---

## üß† Logica Allarmi Intelligenti

Gli allarmi non segnalano solo "dati mancanti", ma "necessit√† operative immediate". La logica √® centralizzata nella vista DB `vw_noleggi_allarmi`.

### 1. Contratti (Regola di Business)
- **Criterio**: Viene sollevato un allarme SOLO se `anagrafica.richiede_contratto_noleggio = true`.
- **Perch√©**: Evitiamo "rumore" per clienti che lavorano con ordini aperti o procedure diverse.

### 2. Trasporti (Regola Temporale)
- **Finestra Temporale**: ¬±7 giorni dalla data di inizio (`consegna`) o fine (`ritiro`).
- **Logica**: Se un noleggio scade tra 6 mesi, non √® utile vedere che manca il trasporto. L'operatore viene avvisato solo quando l'evento √® imminente.
- **Tempo Indeterminato**: Per i noleggi aperti, l'allarme `ritiro` √® disattivato per default.

---

## üõ†Ô∏è Architettura Tecnica

### 1. Database (The Source of Truth)
- **`vw_noleggi_allarmi`**: Il nucleo della logica. Estende `vw_noleggi_completi` aggiungendo campi booleani `allarme_*`.
- **`noleggi_trasporti`**: La tabella di join arricchita con `tipo_trasporto ('consegna', 'ritiro')`. Questa √® la "chiave" per mappare correttamente i trasporti al contesto del noleggio.

### 2. Frontend (Hooks & UI)
- **`useNoleggiStats.ts`**: Il bridge tra DB e UI. Mappa i campi della vista nell'interfaccia `NoleggiConAllarmi`. **IMPORTANTE**: Non ricalcolare la logica allarmi qui; usa i campi della vista.
- **`NoleggiFilteredDialog.tsx`**: Gestisce le azioni contestuali. Filtra i pulsanti in base al tipo di allarme cliccato (es. filtrando per trasporti, mostra solo bottoni trasporti).

---

## ‚ö†Ô∏è Anti-Patterns da Evitare (Per Agenti AI)

1. **AP01 (Automazione Cieca)**: Non creare record trasporti automaticamente al create noleggio. Aspetta l'intento dell'operatore (click su "Richiedi Trasporto").
2. **Duplicazione Logica**: Non scrivere calcoli di date per gli allarmi nel TSX. Se la logica cambia, deve cambiare nella Vista SQL.
3. **Hardcoding Sedi**: Non assumere che la sede MVC sia fissa. Usa le sedi collegate al noleggio o ubicazione.

---

## üìÇ File Correlati
- `src/hooks/useNoleggiStats.ts` (Data Fetching)
- `src/components/noleggi/NoleggiDashboard.tsx` (Visualizzazione)
- `src/components/trasporti/RichiediTrasportoDialog.tsx` (Action Form)
